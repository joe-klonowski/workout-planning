echo "Checking staged files to decide whether to run frontend and backend pre-commit checks..."
# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMRT)

# If no staged files, skip checks
if [ -z "$STAGED_FILES" ]; then
  echo "No staged files. Skipping pre-commit checks."
  exit 0
fi

# Frontend checks: run only if any staged files are frontend-related
# Current rule: files under `app/` or root package files trigger frontend checks
if echo "$STAGED_FILES" | grep -E '^(app/|package.json|yarn.lock|package-lock.json)' > /dev/null; then
  echo "Running lint-staged for frontend changes..."
  # Run project-local lint-staged from the app/ package to avoid npx installing
  # a potentially incompatible global version (string-width regexp flags differ by Node version).
  npm --prefix app exec -- lint-staged || {
    echo "Pre-commit check failed: lint-staged failed. Commit aborted."
    exit 1
  }

  echo "Running ESLint regression check (no regressions allowed)..."
  node ./scripts/check-eslint-regression.js || {
    echo "Pre-commit check failed: ESLint regression (error count increased). Commit aborted."
    exit 1
  }

  # Run console baseline tests only when source files in app/src are changed.
  if echo "$STAGED_FILES" | grep -E '^(app/src/)' > /dev/null; then
    echo "Running console baseline pre-commit check..."
    CONSOLE_BASELINE_MODE=fail TEST_TIMEOUT=20 ./test-frontend.sh || {
      echo "Pre-commit check failed: console baseline check failed. Commit aborted."
      exit 1
    }
  else
    echo "No app/src changes. Skipping console baseline check."
  fi
else
  echo "No frontend files changed. Skipping frontend pre-commit checks."
fi

# Backend checks: run only if any staged files are backend-related
# Rule: files under `backend/` trigger backend checks
if echo "$STAGED_FILES" | grep -E '^(backend/)' > /dev/null; then
  echo "Running backend tests..."
  ./test-backend.sh || {
    echo "Pre-commit check failed: backend tests failed. Commit aborted."
    exit 1
  }
else
  echo "No backend files changed. Skipping backend pre-commit checks."
fi